task:requests:rate10s = rate(requests{job="lb"}[10s])

job:requests:rate10s = sum by (job)(task:requests:rate10s{job="lb"})

task:errors:rate10s = rate(errors{job="lb"}[10s])

job:errors:rate10s = sum by (job, code)(task:errors:rate10s{job="lb"})

job:errors:ratio_rate10s =
   sum by (job)(job:errors:rate10s{job="lb"})
     / on (job)
   job:requests:rate10s{job="lb"}


ALERT ErrorRatioTooHigh
IF job:errors:ratio_rate10s{job="lb"} > 0.2
FOR 10s
LABELS { severity="page" }
ANNOTATIONS {
summary = "Error ratio exceeds 20%",
description = "Error ratio of {{$labels.code}} on {{$labels.job}} is at {{$value}}",
}
